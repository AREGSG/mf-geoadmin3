if(window.Proj4js&&!Proj4js.util){Proj4js.util={}}(window.Proj4js?Proj4js.util:window)["MGRS"]=function(){function a(e,t){t=t||5;return v(h({lat:e.lat,lon:e.lon}),t)}function f(e){var t=p(b(e.toUpperCase()));return[t.left,t.bottom,t.right,t.top]}function l(e){return e*(Math.PI/180)}function c(e){return 180*(e/Math.PI)}function h(e){var t=e.lat;var n=e.lon;var r=6378137;var i=.00669438;var s=.9996;var o;var u;var a,f,c,h,p;var v=l(t);var m=l(n);var g;var y;y=Math.floor((n+180)/6)+1;if(n==180){y=60}if(t>=56&&t<64&&n>=3&&n<12){y=32}if(t>=72&&t<84){if(n>=0&&n<9)y=31;else if(n>=9&&n<21)y=33;else if(n>=21&&n<33)y=35;else if(n>=33&&n<42)y=37}o=(y-1)*6-180+3;g=l(o);u=i/(1-i);a=r/Math.sqrt(1-i*Math.sin(v)*Math.sin(v));f=Math.tan(v)*Math.tan(v);c=u*Math.cos(v)*Math.cos(v);h=Math.cos(v)*(m-g);p=r*((1-i/4-3*i*i/64-5*i*i*i/256)*v-(3*i/8+3*i*i/32+45*i*i*i/1024)*Math.sin(2*v)+(15*i*i/256+45*i*i*i/1024)*Math.sin(4*v)-35*i*i*i/3072*Math.sin(6*v));var b=s*a*(h+(1-f+c)*h*h*h/6+(5-18*f+f*f+72*c-58*u)*h*h*h*h*h/120)+5e5;var w=s*(p+a*Math.tan(v)*(h*h/2+(5-f+9*c+4*c*c)*h*h*h*h/24+(61-58*f+f*f+600*c-330*u)*h*h*h*h*h*h/720));if(t<0){w+=1e7}return{northing:Math.round(w),easting:Math.round(b),zoneNumber:y,zoneLetter:d(t)}}function p(e){var t=e.northing;var n=e.easting;var r=e.zoneLetter;var i=e.zoneNumber;if(i<0||i>60){return null}var s=.9996;var o=6378137;var u=.00669438;var a;var f=(1-Math.sqrt(1-u))/(1+Math.sqrt(1-u));var l,h,d,v,m,g;var y;var b,w;var E=n-5e5;var S=t;if(r=="S"){S-=1e7}y=(i-1)*6-180+3;a=u/(1-u);g=S/s;b=g/(o*(1-u/4-3*u*u/64-5*u*u*u/256));w=b+(3*f/2-27*f*f*f/32)*Math.sin(2*b)+(21*f*f/16-55*f*f*f*f/32)*Math.sin(4*b)+151*f*f*f/96*Math.sin(6*b);l=o/Math.sqrt(1-u*Math.sin(w)*Math.sin(w));h=Math.tan(w)*Math.tan(w);d=a*Math.cos(w)*Math.cos(w);v=o*(1-u)/Math.pow(1-u*Math.sin(w)*Math.sin(w),1.5);m=E/(l*s);var x=w-l*Math.tan(w)/v*(m*m/2-(5+3*h+10*d-4*d*d-9*a)*m*m*m*m/24+(61+90*h+298*d+45*h*h-252*a-3*d*d)*m*m*m*m*m*m/720);x=c(x);var T=(m-(1+2*h+d)*m*m*m/6+(5-2*d+28*h-3*d*d+8*a+24*h*h)*m*m*m*m*m/120)/Math.cos(w);T=y+c(T);var N;if(e.accuracy){var C=p({northing:e.northing+e.accuracy,easting:e.easting+e.accuracy,zoneLetter:e.zoneLetter,zoneNumber:e.zoneNumber});N={top:C.lat,right:C.lon,bottom:x,left:T}}else{N={lat:x,lon:T}}return N}function d(e){var t="Z";if(84>=e&&e>=72)t="X";else if(72>e&&e>=64)t="W";else if(64>e&&e>=56)t="V";else if(56>e&&e>=48)t="U";else if(48>e&&e>=40)t="T";else if(40>e&&e>=32)t="S";else if(32>e&&e>=24)t="R";else if(24>e&&e>=16)t="Q";else if(16>e&&e>=8)t="P";else if(8>e&&e>=0)t="N";else if(0>e&&e>=-8)t="M";else if(-8>e&&e>=-16)t="L";else if(-16>e&&e>=-24)t="K";else if(-24>e&&e>=-32)t="J";else if(-32>e&&e>=-40)t="H";else if(-40>e&&e>=-48)t="G";else if(-48>e&&e>=-56)t="F";else if(-56>e&&e>=-64)t="E";else if(-64>e&&e>=-72)t="D";else if(-72>e&&e>=-80)t="C";return t}function v(e,t){var n=""+e.easting,r=""+e.northing;return e.zoneNumber+e.zoneLetter+m(e.easting,e.northing,e.zoneNumber)+n.substr(n.length-5,t)+r.substr(r.length-5,t)}function m(e,t,n){var r=g(n);var i=Math.floor(e/1e5);var s=Math.floor(t/1e5)%20;return y(i,s,r)}function g(t){var n=t%e;if(n==0)n=e;return n}function y(e,a,f){var l=f-1;var c=t.charCodeAt(l);var h=n.charCodeAt(l);var p=c+e-1;var d=h+a;var v=false;if(p>u){p=p-u+r-1;v=true}if(p==i||c<i&&p>i||(p>i||c<i)&&v){p++}if(p==s||c<s&&p>s||(p>s||c<s)&&v){p++;if(p==i){p++}}if(p>u){p=p-u+r-1}if(d>o){d=d-o+r-1;v=true}else{v=false}if(d==i||h<i&&d>i||(d>i||h<i)&&v){d++}if(d==s||h<s&&d>s||(d>s||h<s)&&v){d++;if(d==i){d++}}if(d>o){d=d-o+r-1}var m=String.fromCharCode(p)+String.fromCharCode(d);return m}function b(e){if(e==null||e.length==0){throw"MGRSPoint coverting from nothing"}var t=e.length;var n=null;var r="";var i;var s=0;while(!/[A-Z]/.test(i=e.charAt(s))){if(s>=2){throw"MGRSPoint bad conversion from: "+e}r+=i;s++}var o=parseInt(r,10);if(s==0||s+3>t){throw"MGRSPoint bad conversion from: "+e}var u=e.charAt(s++);if(u<="A"||u=="B"||u=="Y"||u>="Z"||u=="I"||u=="O"){throw"MGRSPoint zone letter "+u+" not handled: "+e}n=e.substring(s,s+=2);var a=g(o);var f=w(n.charAt(0),a);var l=E(n.charAt(1),a);while(l<S(u)){l+=2e6}var c=t-s;if(c%2!=0){throw"MGRSPoint has to have an even number \nof digits after the zone letter and two 100km letters - front \nhalf for easting meters, second half for \nnorthing meters"+e}var h=c/2;var p=0;var d=0;if(h>0){var v=1e5/Math.pow(10,h);var m=e.substring(s,s+h);p=parseFloat(m)*v;var y=e.substring(s+h);d=parseFloat(y)*v}easting=p+f;northing=d+l;return{easting:easting,northing:northing,zoneLetter:u,zoneNumber:o,accuracy:v}}function w(e,n){var o=t.charCodeAt(n-1);var a=1e5;var f=false;while(o!=e.charCodeAt(0)){o++;if(o==i)o++;if(o==s)o++;if(o>u){if(f){throw"Bad character: "+e}o=r;f=true}a+=1e5}return a}function E(e,t){if(e>"V"){throw"MGRSPoint given invalid Northing "+e}var u=n.charCodeAt(t-1);var a=0;var f=false;while(u!=e.charCodeAt(0)){u++;if(u==i)u++;if(u==s)u++;if(u>o){if(f){throw"Bad character: "+e}u=r;f=true}a+=1e5}return a}function S(e){var t;switch(e){case"C":t=11e5;break;case"D":t=2e6;break;case"E":t=28e5;break;case"F":t=37e5;break;case"G":t=46e5;break;case"H":t=55e5;break;case"J":t=64e5;break;case"K":t=73e5;break;case"L":t=82e5;break;case"M":t=91e5;break;case"N":t=0;break;case"P":t=8e5;break;case"Q":t=17e5;break;case"R":t=26e5;break;case"S":t=35e5;break;case"T":t=44e5;break;case"U":t=53e5;break;case"V":t=62e5;break;case"W":t=7e6;break;case"X":t=79e5;break;default:t=-1}if(t>=0){return t}else{throw"Invalid zone letter: "+e}}var e=6;var t="AJSAJS";var n="AFAFAF";var r=65;var i=73;var s=79;var o=86;var u=90;return{forward:a,inverse:f}}();if(window.Proj4js&&Proj4js.Point){Proj4js.Point.fromMGRS=function(e){var t=Proj4js.util.MGRS.inverse(e);return new Proj4js.Point((t[2]+t[0])/2,(t[3]+t[1])/2)};Proj4js.Point.prototype.toMGRS=function(e){return Proj4js.util.MGRS.forward({lon:this.x,lat:this.y},e)}}
